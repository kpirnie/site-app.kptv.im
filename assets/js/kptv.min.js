var DOMReady=function(e){"interactive"===document.readyState||"complete"===document.readyState?e():document.addEventListener?document.addEventListener("DOMContentLoaded",e):document.attachEvent&&document.attachEvent("onreadystatechange",function(){"loading"!=document.readyState&&e()})};const KPTV={init:function(){this.initScrollToTop(),this.initMobileMenu(),this.initTableSort(),this.initSearch(),this.initPerPage(),console.log("KPTV Stream Manager initialized")},initScrollToTop:function(){const e=document.getElementById("kptv-scroll-top");if(!e)return;window.addEventListener("scroll",function(){window.scrollY>150?e.classList.add("visible"):e.classList.remove("visible")},{passive:!0}),e.addEventListener("click",function(e){e.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})})},initMobileMenu:function(){document.querySelectorAll(".kptv-offcanvas-nav a:not(.uk-parent > a)").forEach(function(e){e.addEventListener("click",function(){const e=document.getElementById("kptv-mobile-nav");e&&"undefined"!=typeof UIkit&&UIkit.offcanvas(e).hide()})});document.querySelectorAll(".kptv-offcanvas-nav .uk-parent > a").forEach(function(e){e.addEventListener("click",function(e){})})},initTableSort:function(){const e=document.querySelectorAll(".kptv-table th[data-sort]");e.forEach(function(t){t.style.cursor="pointer",t.addEventListener("click",function(){const t=this.closest("table").querySelector("tbody"),n=Array.from(t.querySelectorAll("tr")),o=(this.dataset.sort,Array.from(this.parentElement.children).indexOf(this)),i=this.classList.contains("asc");e.forEach(function(e){e.classList.remove("asc","desc")}),n.sort(function(e,t){const n=e.children[o].textContent.trim(),a=t.children[o].textContent.trim(),s=parseFloat(n),r=parseFloat(a);return isNaN(s)||isNaN(r)?i?a.localeCompare(n):n.localeCompare(a):i?r-s:s-r}),this.classList.add(i?"desc":"asc"),n.forEach(function(e){t.appendChild(e)})})})},initSearch:function(){document.querySelectorAll(".kptv-search input").forEach(function(e){let t;e.addEventListener("input",function(){clearTimeout(t);const e=this.value.toLowerCase(),n=document.querySelector(this.dataset.target||".kptv-table");t=setTimeout(function(){if(!n)return;n.querySelectorAll("tbody tr").forEach(function(t){const n=t.textContent.toLowerCase();t.style.display=n.includes(e)?"":"none"}),KPTV.updateVisibleCount(n)},300)})})},initPerPage:function(){const e=document.querySelectorAll(".kptv-per-page-btn");e.forEach(function(t){t.addEventListener("click",function(t){t.preventDefault(),e.forEach(function(e){e.classList.remove("active")}),this.classList.add("active");const n=this.dataset.perpage,o=document.querySelector(this.dataset.target||".kptv-table");if(!o)return;const i=o.querySelectorAll("tbody tr"),a="all"===n,s=parseInt(n,10);i.forEach(function(e,t){e.style.display=a||t<s?"":"none"}),KPTV.updateVisibleCount(o)})})},updateVisibleCount:function(e){const t=document.querySelector(".kptv-record-count");if(!t||!e)return;const n=e.querySelectorAll("tbody tr").length,o=e.querySelectorAll('tbody tr:not([style*="display: none"])').length;t.textContent="Showing "+o+" of "+n+" records"},formatNumber:function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},debounce:function(e,t){let n;return function(){const o=this,i=arguments;clearTimeout(n),n=setTimeout(function(){n=null,e.apply(o,i)},t)}}};function MyInit(){document.querySelector(".the-datatable");document.addEventListener("click",function(e){const t=e.target.closest(".active-toggle");if(t){e.preventDefault(),e.stopPropagation();const n=t.dataset.id,o=document.createElement("form");o.method="POST",o.action="";const i=document.createElement("input");i.type="hidden",i.name="form_action",i.value="toggle-active";const a=document.createElement("input");a.type="hidden",a.name="id",a.value=n,o.appendChild(i),o.appendChild(a),document.body.appendChild(o),o.submit()}}),document.addEventListener("click",function(e){const t=e.target.closest(".stream-channel.channel-cell");if(t&&!t.querySelector("input")){e.stopPropagation();const n=t,o=n.textContent.trim(),i=n.closest("tr").querySelector(".record-checkbox").value,a=document.createElement("input");a.type="text",a.value=o,a.className="uk-input uk-form-small",n.textContent="",n.appendChild(a),a.focus();const r=function(e){"Enter"===e.key?(l(i,a.value.trim(),n,o),a.removeEventListener("keydown",r),a.removeEventListener("blur",c)):"Escape"===e.key&&(s(n,o),a.removeEventListener("keydown",r),a.removeEventListener("blur",c))},c=function(){l(i,a.value.trim(),n,o),a.removeEventListener("keydown",r),a.removeEventListener("blur",c)};a.addEventListener("keydown",r),a.addEventListener("blur",c)}}),document.addEventListener("click",function(e){const t=e.target.closest(".stream-name.name-cell");if(t&&!t.querySelector("input")){e.stopPropagation();const n=t,o=n.textContent.trim(),i=n.closest("tr").querySelector(".record-checkbox").value,s=document.createElement("input");s.type="text",s.value=o,s.className="uk-input uk-form-small",n.textContent="",n.appendChild(s),s.focus();const l=function(e){"Enter"===e.key?(r(i,s.value.trim(),n,o),s.removeEventListener("keydown",l),s.removeEventListener("blur",c)):"Escape"===e.key&&(a(n,o),s.removeEventListener("keydown",l),s.removeEventListener("blur",c))},c=function(){r(i,s.value.trim(),n,o),s.removeEventListener("keydown",l),s.removeEventListener("blur",c)};s.addEventListener("keydown",l),s.addEventListener("blur",c)}}),document.querySelectorAll(".activate-streams").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=document.querySelectorAll(".record-checkbox:checked");if(0===t.length)return void alert("Please select at least one stream to activate.");if(!confirm(`Activate ${t.length} selected stream(s)?`))return;const n=document.createElement("form");n.method="POST",n.action="";const o=document.createElement("input");o.type="hidden",o.name="form_action",o.value="activate-streams",n.appendChild(o);const i=new URLSearchParams(window.location.search),a=document.createElement("input");a.type="hidden",a.name="sort",a.value=i.get("sort")||"sp_priority",n.appendChild(a);const s=document.createElement("input");s.type="hidden",s.name="dir",s.value=i.get("dir")||"asc",n.appendChild(s),t.forEach(e=>{const t=document.createElement("input");t.type="hidden",t.name="ids[]",t.value=e.value,n.appendChild(t)}),document.body.appendChild(n),n.submit()})});document.querySelectorAll("tbody tr").forEach(e=>{const t=Array.from(e.cells).slice(0,-1),n=e.querySelector(".record-checkbox");t.forEach(e=>{e.querySelector(".active-toggle")||e.classList.contains("stream-name")||e.classList.contains("stream-channel")||e.querySelector(".copy-link")||(e.style.cursor="pointer",e.addEventListener("click",e=>{if("A"===e.target.tagName||"BUTTON"===e.target.tagName||"INPUT"===e.target.tagName||e.target.classList.contains("copy-link"))return;if(e.target===n)return;n.checked=!n.checked;const t=new Event("change");n.dispatchEvent(t)}))})});const e=document.querySelectorAll(".select-all"),t=document.querySelectorAll(".record-checkbox"),n=document.getElementById("delete-selected");function o(){const n=t.length>0&&[...t].every(e=>e.checked);e.forEach(e=>{e.checked=n,e.indeterminate=!n&&[...t].some(e=>e.checked)})}function i(){if(!n)return;const e=document.querySelectorAll(".record-checkbox:checked");n.disabled=0===e.length}function a(e,t){e.textContent=t,e.classList.add("stream-name"),e.classList.add("name-cell")}function s(e,t){e.textContent=t,e.classList.add("stream-channel"),e.classList.add("channel-cell")}function r(e,t,n,o){if(!t||t===o)return void a(n,o);const i=document.createElement("span");i.setAttribute("uk-spinner","ratio: 0.5"),n.textContent="",n.appendChild(i);const s=new FormData;s.append("form_action","update-name"),s.append("id",e),s.append("s_name",t),fetch(window.location.href,{method:"POST",body:s,headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}}).then(e=>{if(!e.ok)throw new Error("Network response was not ok");return e.text()}).then(e=>e?JSON.parse(e):{}).then(e=>{if(!e.success)throw new Error(e.message||"Update failed");n.textContent=t,n.classList.add("stream-name"),n.classList.add("name-cell"),"undefined"!=typeof UIkit&&UIkit.notification&&UIkit.notification({message:"Name updated successfully",status:"success",pos:"top-right",timeout:2e3})}).catch(e=>{console.error("Error:",e),a(n,o),"undefined"!=typeof UIkit&&UIkit.notification&&UIkit.notification({message:"Error saving: "+e.message,status:"danger",pos:"top-right",timeout:5e3})})}function l(e,t,n,o){if(!t||t===o)return void s(n,o);const i=document.createElement("span");i.setAttribute("uk-spinner","ratio: 0.5"),n.textContent="",n.appendChild(i);const a=new FormData;a.append("form_action","update-channel"),a.append("id",e),a.append("s_channel",t),fetch(window.location.href,{method:"POST",body:a,headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}}).then(e=>{if(!e.ok)throw new Error("Network response was not ok");return e.text()}).then(e=>e?JSON.parse(e):{}).then(e=>{if(!e.success)throw new Error(e.message||"Update failed");n.textContent=t,n.classList.add("stream-channel"),n.classList.add("channel-cell"),"undefined"!=typeof UIkit&&UIkit.notification&&UIkit.notification({message:"Channel updated successfully",status:"success",pos:"top-right",timeout:2e3})}).catch(e=>{console.error("Error:",e),s(n,o),"undefined"!=typeof UIkit&&UIkit.notification&&UIkit.notification({message:"Error saving channel: "+e.message,status:"danger",pos:"top-right",timeout:5e3})})}e.forEach(e=>{e.addEventListener("change",function(){const e=this.checked;t.forEach(t=>{t.checked=e}),i()})}),t.forEach(e=>{e.addEventListener("change",function(){o(),i()})}),o(),i(),document.querySelectorAll(".delete-selected").forEach(e=>{e.addEventListener("click",function(){const e=document.querySelectorAll(".record-checkbox:checked");if(0===e.length)return void alert("Please select at least one item to delete.");if(!confirm(`Delete ${e.length} selected item(s)?`))return;const t=document.createElement("form");t.method="POST",t.action="";const n=document.createElement("input");n.type="hidden",n.name="form_action",n.value="delete-multiple",t.appendChild(n);const o=new URLSearchParams(window.location.search),i=document.createElement("input");i.type="hidden",i.name="sort",i.value=o.get("sort")||"sp_priority",t.appendChild(i);const a=document.createElement("input");a.type="hidden",a.name="dir",a.value=o.get("dir")||"asc",t.appendChild(a),e.forEach(e=>{const n=document.createElement("input");n.type="hidden",n.name="ids[]",n.value=e.value,t.appendChild(n)}),document.body.appendChild(t),t.submit()})}),document.addEventListener("click",function(e){const t=e.target.closest(".copy-link");if(t){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const n=t.getAttribute("href");if(navigator.clipboard)navigator.clipboard.writeText(n).then(function(){UIkit.notification({message:"Your data has been copied to your clipboard!",status:"success",pos:"top-center",timeout:5e3})}).catch(function(e){UIkit.notification({message:"Failed to copy: "+e,status:"danger",pos:"top-center",timeout:5e3})});else{const e=document.createElement("input");document.body.appendChild(e),e.value=n,e.select();try{if(!document.execCommand("copy"))throw new Error("Copy command failed");UIkit.notification({message:"Your data has been copied to your clipboard!",status:"success",pos:"top-center",timeout:5e3})}catch(e){UIkit.notification({message:"Failed to copy: "+e,status:"danger",pos:"top-center",timeout:5e3})}document.body.removeChild(e)}}})}DOMReady(function(){KPTV.init(),MyInit()});class MultiFormatPlayer{constructor(e="the_streamer",t="vid_modal"){this.videoElement=document.getElementById(e),this.modal=UIkit.modal(`#${t}`),this.currentPlayer=null,this.playerType=null,this.proxyUrl="/proxy/stream",this.originalUrl=null,this.loadingModal=null,this.videoJsPlayer=null,this.players={hls:null,mpegts:null,videojs:null,native:null}}async play(e,t={}){console.log("Play method called with URL:",e),this.originalUrl=e;const n=!1!==t.useProxy,o=n?this.getProxiedUrl(e):e;this.showLoadingModal(),this.cleanup();const i=this.detectStreamType(e);console.log(`Attempting to play: ${e}`),console.log(`Detected type: ${i}`);let a=!1;switch(i){case"hls":a=await this.tryHLS(o)||await this.tryVideoJS(o)||await this.tryNative(o);break;case"mpegts":a=await this.tryMpegTS(o),a||(await this.delay(300),console.log("mpegts.js failed, trying .m3u8 fallback..."),a=await this.tryTsToM3u8Fallback(e,n)),a||(await this.delay(300),console.log(".m3u8 fallback failed, trying remaining players..."),a=await this.tryVideoJS(o));break;case"video":a=await this.tryNative(o)||await this.tryVideoJS(o);break;default:a=await this.tryHLS(o),a||(await this.delay(300),a=await this.tryMpegTS(o)),!a&&e.toLowerCase().includes(".ts")&&(await this.delay(300),console.log("Trying .ts to .m3u8 fallback for unknown type..."),a=await this.tryTsToM3u8Fallback(e,n)),a||(await this.delay(300),a=await this.tryVideoJS(o)),a||(await this.delay(300),a=await this.tryNative(o))}a?(this.hideLoadingModal(),this.modal.show()):(this.hideLoadingModal(),this.showFallbackModal())}detectStreamType(e){const t=e.toLowerCase();return t.includes(".m3u8")||t.includes("/hls/")?"hls":t.includes(".ts")&&!t.includes(".m3u8")?"mpegts":t.match(/\.(mp4|webm|ogg|mov)$/)?"video":"unknown"}getProxiedUrl(e){return`${window.location.origin}/proxy/stream?url=${encodeURIComponent(e)}`}showLoadingModal(){if(!document.getElementById("loading_modal")){const e='\n                <div id="loading_modal" uk-modal>\n                    <div class="uk-modal-dialog uk-modal-body uk-text-center">\n                        <div uk-spinner="ratio: 2"></div>\n                        <p class="uk-margin-top">Loading stream...</p>\n                    </div>\n                </div>\n            ';document.body.insertAdjacentHTML("beforeend",e)}this.loadingModal=UIkit.modal("#loading_modal",{bgClose:!1,escClose:!1}),this.loadingModal.show()}hideLoadingModal(){this.loadingModal&&(this.loadingModal.hide(),this.loadingModal=null)}async delay(e=500){return new Promise(t=>setTimeout(t,e))}async tryTsToM3u8Fallback(e,t){if(!e.toLowerCase().includes(".ts"))return!1;console.log("Trying .ts to .m3u8 fallback...");let n=e.replace(/\.ts$/i,".m3u8");if(n===e&&(n=e.replace(/\.ts/gi,".m3u8"),n===e))return!1;const o=t?this.getProxiedUrl(n):n;return console.log(`Trying HLS equivalent: ${n}`),await this.tryHLS(o)}async tryHLS(e){return window.Hls&&Hls.isSupported()?new Promise(t=>{console.log("Trying HLS.js...");const n=new Hls({debug:!1,enableWorker:!0,lowLatencyMode:!0,backBufferLength:90});this.players.hls=n,n.on(Hls.Events.MANIFEST_PARSED,()=>{console.log("HLS.js: Manifest parsed successfully"),this.videoElement.play().then(()=>{this.currentPlayer="hls",this.hideLoadingModal(),t(!0)}).catch(e=>{console.error("HLS.js: Play failed",e),this.safeDestroyHLS(),t(!1)})}),n.on(Hls.Events.ERROR,(e,n)=>{console.error("HLS.js error:",n),n.fatal&&(this.safeDestroyHLS(),t(!1))}),n.loadSource(e),n.attachMedia(this.videoElement),setTimeout(()=>{this.currentPlayer||(this.safeDestroyHLS(),t(!1))},5e3)}):(console.log("HLS.js not supported"),!1)}async tryMpegTS(e){return window.mpegts&&mpegts.isSupported()?new Promise(t=>{console.log("Trying mpegts.js...");try{const n=mpegts.createPlayer({type:"mse",isLive:!0,url:e,hasAudio:!0,hasVideo:!0},{enableStashBuffer:!1,stashInitialSize:128,enableWorker:!0,lazyLoadMaxDuration:180,seekType:"range"});this.players.mpegts=n,n.on(mpegts.Events.ERROR,e=>{console.error("mpegts.js error:",e),this.safePauseMpegTS(),this.players.mpegts=null,t(!1)}),n.on(mpegts.Events.MEDIA_INFO,e=>{console.log("mpegts.js: Media info received",e)}),n.on(mpegts.Events.LOADSTART,()=>{console.log("mpegts.js: Load started"),this.videoElement.play().then(()=>{this.currentPlayer="mpegts",this.hideLoadingModal(),t(!0)}).catch(e=>{console.error("mpegts.js: Play failed",e),this.safePauseMpegTS(),this.players.mpegts=null,t(!1)})}),n.attachMediaElement(this.videoElement),n.load(),n.play(),setTimeout(()=>{this.currentPlayer||(this.safePauseMpegTS(),this.players.mpegts=null,t(!1))},5e3)}catch(e){console.error("mpegts.js initialization failed:",e),this.players.mpegts=null,t(!1)}}):(console.log("mpegts.js not supported"),!1)}async tryVideoJS(e){return window.videojs?new Promise(t=>{console.log("Trying Video.js...");try{this.videoJsPlayer||(this.videoJsPlayer=videojs(this.videoElement.id,{controls:!0,autoplay:!1,preload:"auto",fluid:!0,liveui:!0,html5:{vhs:{overrideNative:!0,smoothQualityChange:!0,fastQualityChange:!0}}})),this.players.videojs=this.videoJsPlayer,this.videoJsPlayer.ready(()=>{this.videoJsPlayer.src({src:e,type:this.getVideoJsType(e)}),this.videoJsPlayer.one("loadedmetadata",()=>{console.log("Video.js: Metadata loaded"),this.videoJsPlayer.play().then(()=>{this.currentPlayer="videojs",this.hideLoadingModal(),t(!0)}).catch(e=>{console.error("Video.js: Play failed",e),t(!1)})}),this.videoJsPlayer.one("error",()=>{console.error("Video.js: Error loading"),t(!1)}),setTimeout(()=>{this.currentPlayer||t(!1)},5e3)})}catch(e){console.error("Video.js initialization failed:",e),t(!1)}}):(console.log("Video.js not available"),!1)}async tryNative(e){return new Promise(t=>{if(console.log("Trying native HTML5 video..."),"mpegts"===this.detectStreamType(e))return console.log("Skipping native player for MPEG-TS format"),void t(!1);try{if(this.videoJsPlayer){this.videoJsPlayer.dispose(),this.videoJsPlayer=null;const e=this.videoElement.parentNode;if(e){const t=document.createElement("video");t.id=this.videoElement.id,t.className=this.videoElement.className,t.controls=!0,t.width=800,t.height=450,e.replaceChild(t,this.videoElement),this.videoElement=t}else{const e=this.videoElement.id;if(this.videoElement=document.getElementById(e),!this.videoElement)return console.error("Native player: Video element not found"),void t(!1)}}this.videoElement.src=e;const n=()=>{console.log("Native player: Playing"),this.currentPlayer="native",this.hideLoadingModal(),i(),t(!0)},o=()=>{console.error("Native player: Error"),i(),t(!1)},i=()=>{this.videoElement.removeEventListener("canplay",n),this.videoElement.removeEventListener("error",o)};this.videoElement.addEventListener("canplay",n,{once:!0}),this.videoElement.addEventListener("error",o,{once:!0}),this.videoElement.load(),setTimeout(()=>{this.currentPlayer||(i(),t(!1))},5e3)}catch(e){console.error("Native player initialization failed:",e),t(!1)}})}getVideoJsType(e){const t=e.toLowerCase();return t.includes(".m3u8")?"application/x-mpegURL":t.includes(".mp4")?"video/mp4":t.includes(".webm")?"video/webm":t.includes(".ogg")?"video/ogg":(t.includes(".ts"),"application/x-mpegURL")}safeDestroyHLS(){if(this.players.hls){try{this.players.hls.destroy()}catch(e){console.error("Error destroying HLS player:",e)}this.players.hls=null}}safePauseMpegTS(){if(this.players.mpegts)try{"function"==typeof this.players.mpegts.pause&&this.players.mpegts.pause(),"function"==typeof this.players.mpegts.unload&&this.players.mpegts.unload(),"function"==typeof this.players.mpegts.detachMediaElement&&this.players.mpegts.detachMediaElement(),"function"==typeof this.players.mpegts.destroy&&this.players.mpegts.destroy()}catch(e){console.error("Error cleaning up mpegts player:",e)}}showFallbackModal(){console.error("All players failed");let e="";"mpegts"===this.detectStreamType(this.originalUrl)&&(e="<p><strong>Note:</strong> This appears to be an MPEG-TS stream, which requires special player support.</p>"),UIkit.modal.alert(`\n            <div class="uk-text-center">\n                <h3 class="uk-text-center">Unable to Play Stream</h3>\n                <p>All web players failed to load this stream.</p>\n                ${e}\n                <p>You can try playing it in VLC Media Player:</p>\n                <div class="uk-margin">\n                    <input type="text" class="uk-input" value="${this.originalUrl}" readonly>\n                </div>\n                <p class="uk-text-center">Copy the URL above and paste it into VLC:<br>\n                Media â†’ Open Network Stream</p>\n            </div>\n        `)}cleanup(){if(console.log("Cleaning up players..."),this.safeDestroyHLS(),this.safePauseMpegTS(),this.players.mpegts=null,this.videoJsPlayer)try{this.videoJsPlayer.pause(),this.videoJsPlayer.reset()}catch(e){console.error("Error cleaning up Video.js:",e)}try{this.videoElement&&"function"==typeof this.videoElement.load&&(this.videoElement.src="",this.videoElement.load())}catch(e){console.error("Error resetting native video:",e)}this.currentPlayer=null}stop(){this.cleanup(),this.hideLoadingModal(),this.modal.hide()}}let multiPlayer;function playStream(e,t=!0){multiPlayer||(multiPlayer=new MultiFormatPlayer("the_streamer","vid_modal")),multiPlayer.play(e,{useProxy:t})}document.addEventListener("DOMContentLoaded",function(){multiPlayer=new MultiFormatPlayer("the_streamer","vid_modal"),UIkit.util.on("#vid_modal","hidden",function(){multiPlayer&&multiPlayer.cleanup()})}),document.addEventListener("click",function(e){const t=e.target.closest(".play-stream");if(t){e.preventDefault();const n=t.getAttribute("data-stream-url");n?playStream(n):console.error("No data-stream-url attribute found on element")}});