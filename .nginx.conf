
# Default security headers
add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload"; # enable, cache, and preload subdomains
add_header X-Frame-Options "SAMEORIGIN" always; # generally only allow SAMEORIGIN frame sources
add_header X-Content-Type-Options "nosniff" always; # no sniffing allowed!
add_header Referrer-Policy "strict-origin"; # protect agains cross-linking
add_header X-Download-Options "noopen"; # force the download, and do not allow direct openning
add_header X-Permitted-Cross-Domain-Policies "none"; # protect agains cross-linking
add_header X-Robots-Tag none; # only allow robots.txt# Content Security Policy
add_header Cross-Origin-Embedder-Policy "unsafe-none";
add_header Cross-Origin-Opener-Policy "same-origin";
add_header Cross-Origin-Resource-Policy "same-site";
add_header Access-Control-Allow-Methods "GET, HEAD, POST";
add_header Access-Control-Allow-Origin "*";
set $CSP_image "img-src 'self' data: cdn.kevp.us http: https:;"; # allowable external image domains
set $CSP_script "script-src 'self' 'unsafe-inline' cdn.jsdelivr.net www.google.com www.gstatic.com;"; # allowable external jaavscript domains
set $CSP_style "style-src 'self' 'unsafe-inline' cdn.jsdelivr.net;"; # allowable external CSS domains
set $CSP_font "font-src 'self' data: fonts.googleapis.com fonts.gstatic.com;"; # allowable external font domains
set $CSP_frame "frame-src 'self' vlc:// vlc-media:// www.google.com;"; # allowable external frames/iframes domains
set $CSP_object "object-src 'self';"; # allowable external object domains
set $CSP_connect "connect-src 'self' https: wss:;"; # allowable external connect domains
set $CSP_media "media-src 'self' blob:;"; # allowable external media domains
set $CSP_form "form-action 'self';"; # allowable external form domains
set $CSP_frame_anc "frame-ancestors 'self' vlc:// vlc-media://;"; # allowable external frame ancestor domains
set $CSP_default "default-src 'self';"; # allowable default sources
set $CSP_child "child-src 'self';";
set $CSP_manifest "manifest-src 'self';";
set $CSP_navigate "navigate-to 'self';";
set $CSP_prefetch "prefetch-src 'self';";
set $CSP_script_src_elem "script-src-elem 'self' 'unsafe-inline' cdnjs.cloudflare.com vjs.zencdn.net cdn.jsdelivr.net www.google.com www.gstatic.com;";
set $CSP_script_src_attr "script-src-attr 'self' 'unsafe-inline';";
set $CSP_style_src_elem "style-src-elem 'self' 'unsafe-inline' vjs.zencdn.net cdn.jsdelivr.net fonts.googleapis.com;";
set $CSP_style_src_attr "style-src-attr 'self' 'unsafe-inline';";
set $CSP_worker "worker-src 'self' blob:;";
set $CSP "${CSP_default} ${CSP_image} ${CSP_script} ${CSP_style} ${CSP_font} ${CSP_frame} ${CSP_object} ${CSP_connect} ${CSP_media} ${CSP_form} ${CSP_frame_anc} ${CSP_child} ${CSP_manifest} ${CSP_navigate} ${CSP_prefetch} ${CSP_script_src_elem} ${CSP_script_src_attr} ${CSP_style_src_elem} ${CSP_style_src_attr} ${CSP_worker} upgrade-insecure-requests;";
add_header Content-Security-Policy $CSP always;
add_header X-Content-Security-Policy $CSP always;
add_header Permissions-Policy "interest-cohort=(self), accelerometer=(self), ambient-light-sensor=(self), autoplay=(self), camera=(self), display-capture=(self), document-domain=(self), encrypted-media=(self), execution-while-not-rendered=(self), execution-while-out-of-viewport=(self), fullscreen=(self), gamepad=(self), geolocation=(self), gyroscope=(self), magnetometer=(self), microphone=(self), midi=(self), navigation-override=(self), payment=(self), picture-in-picture=(self), publickey-credentials-get=(self), sync-xhr=(self), usb=(self), xr-spatial-tracking=(self)";
add_header Z-From "Kevin Pirnie";
add_header Z-Magician-Of "DevOps Support Lead, WordPress/Hosting";
add_header Z-Shameless-Plug "https://kevinpirnie.com/";

# Xtream Codes API rewrite
location = /player_api.php {
    rewrite ^/player_api\.php$ /api/xtream last;
}

# pass the video streamer
location ~ ^/stream/play/(.*) {

	# pass the play to the play file
	try_files $uri $uri/ /play.php?stream=$1;

}

# static asset security headers
location ~* \.(?:css|scss|sass|cur|js|jpg|jpeg|webp|gif|htc|ico|png|xml|otf|ttf|eot|woff|woff2|svg|svgx|pdf|xls|xlsx|doc|json|htm|html|mp3|mp4|mkv|ogg|zip|m3u|m3u8)$ {
	
	# security headers
	add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";
	add_header Access-Control-Allow-Methods "GET, HEAD";
	add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Credentials 'true';
    add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
	add_header Expect-Ct "max-age=604800, enforce";
	add_header Content-Security-Policy "upgrade-insecure-requests;";
	add_header X-Content-Security-Policy "upgrade-insecure-requests;";
    add_header X-Content-Type-Options "nosniff";
    add_header Z-From "Kevin Pirnie";
	add_header Z-Magician-Of "DevOps Support Lead, WordPress/Hosting";
    add_header Z-Shameless-Plug "https://kevinpirnie.com/";

	# cache
    expires max;
    add_header Cache-Control public;

	# dont send cookies
	fastcgi_hide_header Set-Cookie;

    # turn off logging
	error_log off;
    log_not_found off; 
	access_log off;
	
}

# =============================================================================
# KPTV Security Rules - Block Access to Sensitive Files
# =============================================================================
# Include this in your server block: include /path/to/nginx-security-rules.conf;
# =============================================================================

# -----------------------------------------------------------------------------
# Block CLI/Sync Directory
# -----------------------------------------------------------------------------
location ^~ /sync/ {
    deny all;
    return 403;
}

# -----------------------------------------------------------------------------
# Block Composer & NPM Files
# -----------------------------------------------------------------------------
location ~ ^/(composer\.json|composer\.lock|package\.json|gulpfile\.js)$ {
    deny all;
    return 403;
}

# -----------------------------------------------------------------------------
# Block Documentation and Config Files
# -----------------------------------------------------------------------------
location ~* ^/(readme\.md|README\.md|CHANGELOG\.md|LICENSE|CONTRIBUTING\.md|\.gitignore|\.gitattributes|\.editorconfig)$ {
    deny all;
    return 403;
}

location ~ ^/assets/config\.json$ {
    deny all;
    return 403;
}

# -----------------------------------------------------------------------------
# Block Backup, Schemas and Log Files
# -----------------------------------------------------------------------------
location ~* \.(sql|sql\.gz|bak|backup|old|orig|log|logs)$ {
    deny all;
    return 403;
}

# -----------------------------------------------------------------------------
# Block Source Control Directories
# -----------------------------------------------------------------------------
location ^~ /.git/ {
    deny all;
    return 403;
}

# -----------------------------------------------------------------------------
# Block YAML and INI Config Files
# -----------------------------------------------------------------------------
location ~* \.(yaml|yml|ini|conf)$ {
    # Allow nginx conf files to be readable for reference if needed
    # Remove this condition if you want to block all conf files
    location ~* nginx.*\.conf$ {
        deny all;
        return 403;
    }
    deny all;
    return 403;
}

# -----------------------------------------------------------------------------
# Block XML Files (except sitemap and feeds)
# -----------------------------------------------------------------------------
location ~* \.xml$ {
    # Allow sitemaps and RSS feeds
    location ~* (sitemap|feed|rss).*\.xml$ {
        allow all;
    }
    deny all;
    return 403;
}