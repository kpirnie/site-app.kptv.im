# =============================================================================
# KPTV Stream Manager - Nginx Security Configuration
# =============================================================================
# Include this in your server block: include /path/to/.nginx.conf;
# =============================================================================

# =============================================================================
# SECURITY HEADERS - Global
# =============================================================================
add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload" always;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header X-Download-Options "noopen" always;
add_header X-Permitted-Cross-Domain-Policies "none" always;
add_header X-Robots-Tag "none" always;
add_header Cross-Origin-Embedder-Policy "unsafe-none" always;
add_header Cross-Origin-Opener-Policy "same-origin" always;
add_header Cross-Origin-Resource-Policy "same-site" always;
add_header Permissions-Policy "accelerometer=(), ambient-light-sensor=(), autoplay=(self), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(self), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(self), gamepad=(), geolocation=(), gyroscope=(), hid=(), idle-detection=(), interest-cohort=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(self), publickey-credentials-get=(), screen-wake-lock=(), serial=(), sync-xhr=(self), usb=(), web-share=(), xr-spatial-tracking=()" always;

# Content Security Policy
set $CSP_default "default-src 'self';";
set $CSP_script "script-src 'self' 'unsafe-inline' cdn.jsdelivr.net cdnjs.cloudflare.com www.google.com www.gstatic.com;";
set $CSP_script_elem "script-src-elem 'self' 'unsafe-inline' cdn.jsdelivr.net cdnjs.cloudflare.com vjs.zencdn.net www.google.com www.gstatic.com;";
set $CSP_script_attr "script-src-attr 'self' 'unsafe-inline';";
set $CSP_style "style-src 'self' 'unsafe-inline' cdn.jsdelivr.net fonts.googleapis.com;";
set $CSP_style_elem "style-src-elem 'self' 'unsafe-inline' cdn.jsdelivr.net vjs.zencdn.net fonts.googleapis.com;";
set $CSP_style_attr "style-src-attr 'self' 'unsafe-inline';";
set $CSP_image "img-src 'self' data: blob: https:;";
set $CSP_font "font-src 'self' data: fonts.gstatic.com fonts.googleapis.com;";
set $CSP_connect "connect-src 'self' wss: https:;";
set $CSP_media "media-src 'self' blob:;";
set $CSP_object "object-src 'none';";
set $CSP_frame "frame-src 'self' www.google.com;";
set $CSP_frame_anc "frame-ancestors 'self';";
set $CSP_form "form-action 'self';";
set $CSP_base "base-uri 'self';";
set $CSP_child "child-src 'self' blob:;";
set $CSP_worker "worker-src 'self' blob:;";
set $CSP_manifest "manifest-src 'self';";
set $CSP "${CSP_default} ${CSP_script} ${CSP_script_elem} ${CSP_script_attr} ${CSP_style} ${CSP_style_elem} ${CSP_style_attr} ${CSP_image} ${CSP_font} ${CSP_connect} ${CSP_media} ${CSP_object} ${CSP_frame} ${CSP_frame_anc} ${CSP_form} ${CSP_base} ${CSP_child} ${CSP_worker} ${CSP_manifest} upgrade-insecure-requests;";
add_header Content-Security-Policy $CSP always;

# Custom headers
add_header X-Powered-By "KPTV Stream Manager" always;

# =============================================================================
# BLOCK SENSITIVE FILES & DIRECTORIES - HIGHEST PRIORITY
# These rules MUST come before any other location blocks
# =============================================================================

# -----------------------------------------------------------------------------
# Block ALL dotfiles and dot-directories (except .well-known)
# -----------------------------------------------------------------------------
location ~ /\.(?!well-known) {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# -----------------------------------------------------------------------------
# Block controllers directory (PHP classes - should never be web accessible)
# -----------------------------------------------------------------------------
location ^~ /controllers/ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# -----------------------------------------------------------------------------
# Block sync directory (CLI tools - should never be web accessible)
# -----------------------------------------------------------------------------
location ^~ /sync/ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# -----------------------------------------------------------------------------
# Block views directory (templates - should never be directly accessible)
# -----------------------------------------------------------------------------
location ^~ /views/ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# -----------------------------------------------------------------------------
# Block vendor directory (Composer packages - should never be web accessible)
# -----------------------------------------------------------------------------
location ^~ /vendor/ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# -----------------------------------------------------------------------------
# Block node_modules directory
# -----------------------------------------------------------------------------
location ^~ /node_modules/ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# -----------------------------------------------------------------------------
# Block cache directory
# -----------------------------------------------------------------------------
location ^~ /.cache/ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# -----------------------------------------------------------------------------
# Block config files in assets
# -----------------------------------------------------------------------------
location = /assets/config.json {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# -----------------------------------------------------------------------------
# Block package manager and build files
# -----------------------------------------------------------------------------
location ~* ^/(composer\.(json|lock)|package(-lock)?\.json|yarn\.lock|gulpfile\.js|gruntfile\.js|webpack\.config\.js|tsconfig\.json|\.babelrc|\.eslintrc|\.prettierrc)$ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# -----------------------------------------------------------------------------
# Block documentation and repository files
# -----------------------------------------------------------------------------
location ~* ^/(readme|README|README\.md|readme\.md|CHANGELOG|CHANGELOG\.md|LICENSE|LICENSE\.md|CONTRIBUTING|CONTRIBUTING\.md|AUTHORS|SECURITY\.md|CODE_OF_CONDUCT\.md|\.gitignore|\.gitattributes|\.gitmodules|\.editorconfig|\.env|\.env\..*)$ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# -----------------------------------------------------------------------------
# Block shell scripts
# -----------------------------------------------------------------------------
location ~* \.(sh|bash|zsh|fish)$ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# -----------------------------------------------------------------------------
# Block database, backup, and log files
# -----------------------------------------------------------------------------
location ~* \.(sql|sql\.gz|sqlite|sqlite3|db|mdb|accdb|bak|backup|old|orig|original|save|swp|swo|tmp|temp|log|logs)$ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# -----------------------------------------------------------------------------
# Block configuration files
# -----------------------------------------------------------------------------
location ~* \.(yaml|yml|ini|conf|cfg|config|toml|properties|htaccess|htpasswd)$ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# -----------------------------------------------------------------------------
# Block certificate and key files
# -----------------------------------------------------------------------------
location ~* \.(pem|crt|cer|key|p12|pfx|jks)$ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# -----------------------------------------------------------------------------
# Block source map files in production
# -----------------------------------------------------------------------------
location ~* \.map$ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# -----------------------------------------------------------------------------
# Block maintenance file
# -----------------------------------------------------------------------------
location = /.maintenance.json {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# =============================================================================
# XTREAM CODES API COMPATIBILITY
# =============================================================================
location = /player_api.php {
    rewrite ^/player_api\.php$ /api/xtream last;
}

# =============================================================================
# STATIC ASSETS - Optimized caching and security
# =============================================================================
location ~* ^/assets/.*\.(?:css|js)$ {
    # Security headers for CSS/JS
    add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Cache-Control "public, max-age=31536000, immutable";
    
    # Disable access logging for performance
    access_log off;
    log_not_found off;
    
    # Remove cookies
    fastcgi_hide_header Set-Cookie;
    
    expires 1y;
}
location ~* ^/assets/.*\.(?:jpg|jpeg|png|gif|webp|ico|svg|svgz|avif)$ {
    # Security headers for images
    add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Cache-Control "public, max-age=31536000, immutable";
    
    # Disable access logging for performance
    access_log off;
    log_not_found off;
    
    # Remove cookies
    fastcgi_hide_header Set-Cookie;
    
    expires 1y;
}
location ~* ^/assets/.*\.(?:woff|woff2|ttf|otf|eot)$ {
    # Security headers for fonts
    add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Access-Control-Allow-Origin "*";
    add_header Cache-Control "public, max-age=31536000, immutable";
    
    # Disable access logging for performance
    access_log off;
    log_not_found off;
    
    # Remove cookies
    fastcgi_hide_header Set-Cookie;
    
    expires 1y;
}

# =============================================================================
# MEDIA FILES - Streaming content
# =============================================================================
location ~* \.(?:m3u8?|ts|mp4|mkv|avi|mov|wmv|flv|webm|m4v|mp3|aac|ogg|opus)$ {
    add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
    add_header Access-Control-Allow-Headers "Range, Origin, Accept, Content-Type";
    add_header Access-Control-Expose-Headers "Content-Length, Content-Range";
    add_header Cache-Control "public, max-age=3600";
    
    # Disable logging for media files
    access_log off;
    log_not_found off;
    
    expires 1h;
}

# =============================================================================
# ROBOTS.TXT - Allow access
# =============================================================================
location = /robots.txt {
    access_log off;
    log_not_found off;
    expires 1d;
}

# =============================================================================
# FAVICON - Allow access
# =============================================================================
location = /favicon.ico {
    access_log off;
    log_not_found off;
    expires 1y;
}

# =============================================================================
# RATE LIMITING FOR API ENDPOINTS (define in http block)
# =============================================================================
# Add to http block:
# limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
# limit_req_zone $binary_remote_addr zone=login_limit:10m rate=1r/s;

# =============================================================================
# ADDITIONAL SECURITY MEASURES
# =============================================================================

# Prevent clickjacking on all responses
add_header X-Frame-Options "SAMEORIGIN" always;

# Prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# XSS Protection (legacy browsers)
add_header X-XSS-Protection "1; mode=block" always;

# Hide server version
server_tokens off;

# Limit request body size (adjust as needed for your uploads)
client_max_body_size 100M;

# Timeout settings
client_body_timeout 60s;
client_header_timeout 60s;
send_timeout 60s;

# Buffer settings to prevent buffer overflow attacks
client_body_buffer_size 16k;
client_header_buffer_size 1k;
large_client_header_buffers 4 8k;